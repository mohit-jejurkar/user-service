pipeline {
   agent none

         stages {

             stage('Checkout Code') {
                                      steps {
                                             checkout scm
                                            }
                                      }

             stage('Build JAR') {
                                 steps {
                                          sh './gradlew clean build -x test'
                                        }
                                 }

             stage('Build Docker Image') {
                                            agent  {
                                                    docker {
                                                       image 'docker:27-cli'
                                                       args '-v /var/run/docker.sock:/var/run/docker.sock'
                                                            }
                                                    }
                                            steps {
                                                   sh 'docker build -t user-service:latest .'
                                                  }
                                          }
  
            stage('Run Docker Container') {
                                            agent {
                                                  docker {
                                                          image 'docker:27-cli'
                                                          args '-v /var/run/docker.sock:/var/run/docker.sock'
                                                          }
                                                  }
                                            steps {
                                                    sh 'docker rm -f user-service || true'
                                                    sh 'docker run -d --name user-service -p 8081:8080 user-service:latest'
                                                  }
                                            }
            }

        post {
               success {
                     echo 'Build & Docker image created successfully'
                       }
               failure {
                     echo 'Build failed'
                       }
            }
}
